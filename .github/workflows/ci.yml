- name: Deploy to EC2 via SSM
  run: |
    IMAGE_URI="${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}"

    aws ssm send-command \
      --document-name "AWS-RunShellScript" \
      --targets "Key=tag:Name,Values=fastapi-ec2-runtime-ec2" \
      --parameters "commands=[
        \"docker pull $IMAGE_URI\",
        \"docker stop fastapi-app || true\",
        \"docker rm fastapi-app || true\",
        \"docker run -d --name fastapi-app -p 8000:8000 $IMAGE_URI\"
      ]" \
      --region us-east-1
